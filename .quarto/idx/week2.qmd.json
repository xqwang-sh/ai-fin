{"title":"第2讲：资产定价中的机器学习应用","markdown":{"yaml":{"title":"第2讲：资产定价中的机器学习应用","subtitle":"问题解构、特征工程与时序评估规范"},"headingText":"资产定价预测的\"特别之处\"","containsRefs":false,"markdown":"\n\n\n### 与典型监督学习的差异\n\n:::{.callout-important}\n🎯 核心认知\n\n资产定价预测**远比标准 i.i.d. 监督学习困难**，原因在于：\n\n1. **极低信噪比**：可预测成分通常 < 5% 方差\n2. **非平稳性**：数据分布随时间变化\n3. **横截面相关**：资产间高度关联\n4. **交易约束**：预测好 ≠ 可交易 ≠ 能赚钱\n:::\n\n#### 低信噪比（Low Signal-to-Noise Ratio）\n\n**典型事实**（来自 Gu, Kelly, Xiu 2020）：\n\n- 个股月度收益预测的 $R^2_{\\text{OOS}} \\approx 0.5\\%$\n- 即使最优模型，95%+ 方差仍是噪声\n- 对比：图像分类任务 $R^2 > 90\\%$\n\n**含义**：\n\n- 复杂模型极易将噪声误认为信号\n- 正则化与集成方法至关重要\n- 评估指标需关注**排序能力**而非绝对预测精度\n\n#### 非平稳性（Non-stationarity）\n\n**表现**：\n\n- 均值/方差随时间变化（如牛市 vs 熊市）\n- 特征–收益关系不稳定（如价值因子的衰退）\n- 新信息源出现（如社交媒体数据）\n\n**挑战**：\n\n- 历史数据未必代表未来\n- 模型需定期重训练\n- 需检验不同市场状态下的稳健性\n\n#### 横截面相关性（Cross-sectional Dependence）\n\n**现实**：\n\n- 股票收益受共同因子驱动（市场、行业、风格）\n- 相关性在危机时期飙升\n- 违反 i.i.d. 假设中的\"独立性\"\n\n**影响**：\n\n- 标准误估计偏小（需聚类调整）\n- 组合风险管理更复杂\n- 需控制因子暴露\n\n#### 交易约束与成本\n\n**现实约束**：\n\n- **流动性**：小市值股票难以大规模交易\n- **交易成本**：佣金、冲击成本、税费\n- **卖空限制**：部分市场卖空困难或成本高\n- **杠杆限制**：借贷成本与上限\n\n:::{.callout-warning}\n⚠️ 为何\"预测更准\"不等于\"更赚钱\"？\n\n**案例**：模型 A 预测 IC = 0.08，模型 B 预测 IC = 0.06\n\n- 若模型 A 的信号波动大 → 高换手率 → 交易成本吞噬收益\n- 若模型 A 偏好小市值股 → 流动性不足 → 难以实施\n- **结论**：模型 B 可能成本后表现更好\n:::\n\n## 问题解构与特征工程\n\n### 预测对象的选择\n\n#### 个股收益（Individual Stock Returns）\n\n$$\nr_{i,t+h} = \\log\\left(\\frac{P_{i,t+h}}{P_{i,t}}\\right)\n$$\n\n- **优点**：直接可交易，信息丰富\n- **缺点**：噪声大，需处理退市/分红\n\n#### 超额收益（Excess Returns）\n\n$$\nr^e_{i,t+h} = r_{i,t+h} - r_{f,t+h}\n$$\n\n或对市场调整：\n\n$$\nr^e_{i,t+h} = r_{i,t+h} - r_{m,t+h}\n$$\n\n- **优点**：去除市场共同成分，提升信噪比\n- **缺点**：需选择基准\n\n#### 多空组合收益（Long-Short Portfolio Returns）\n\n根据预测信号构建分位数组合：\n\n$$\nr^{LS}_{t+h} = r^{\\text{High}}_{t+h} - r^{\\text{Low}}_{t+h}\n$$\n\n- **优点**：直接评估策略表现\n- **缺点**：损失个股级信息\n\n### 特征工程：信息集与时间对齐\n\n#### 信息可得性规则（Information Availability）\n\n:::{.callout-important}\n🔑 黄金法则\n\n**在时刻 $t$ 用于预测的特征，必须在 $t$ 时刻已公开可得！**\n:::\n\n**常见陷阱**：\n\n1. **会计变量披露滞后**\n\n```\n错误：用 2023 年报数据预测 2023 年收益\n正确：用 2022 年报（2023年4月披露）预测 2023年5月后收益\n```\n\n2. **价格数据的\"收盘价陷阱\"**\n\n```\n错误：用 t 日收盘价预测 t 日收益\n正确：用 t-1 日收盘价预测 t 日收益\n```\n\n3. **分析师预测的\"修订滞后\"**\n\n```\n需记录：每个预测的发布时间戳\n对齐：只用发布时间 < t 的预测\n```\n\n#### 特征类别与对齐策略\n\n| 特征类别 | 更新频率 | 披露滞后 | 对齐策略 |\n|---------|---------|---------|---------|\n| **价格/成交量** | 日 | 无 | 用 $t-1$ 预测 $t$ |\n| **会计变量** | 季/年 | 1-4 个月 | 记录披露日期 |\n| **分析师预测** | 不定期 | 无 | 记录时间戳 |\n| **新闻/文本** | 实时 | 几乎无 | 记录发布时间 |\n| **宏观经济** | 月/季 | 数周 | 记录发布日期 |\n\n#### 缺失值处理的时间规范\n\n**原则**：填补方法不能使用未来信息。\n\n✅ **正确做法**：\n\n```python\n# 前向填充（用最近的已知值）\ndf['feature'] = df.groupby('stock_id')['feature'].ffill()\n\n# 或用历史均值（仅用 t 之前数据）\ndf['feature'] = df['feature'].fillna(df['feature'].expanding().mean())\n```\n\n❌ **错误做法**：\n\n```python\n# 用全局均值（包含未来数据）\ndf['feature'] = df['feature'].fillna(df['feature'].mean())\n```\n\n### 标准化的时间规范\n\n**横截面标准化**（cross-sectional）：\n\n$$\n\\tilde{x}_{i,t} = \\frac{x_{i,t} - \\bar{x}_t}{\\sigma_t}\n$$\n\n其中 $\\bar{x}_t, \\sigma_t$ 是时刻 $t$ 的横截面均值/标准差。\n\n✅ **适用场景**：特征在不同时期量纲差异大（如市盈率）\n\n**时间序列标准化**：\n\n$$\n\\tilde{x}_{i,t} = \\frac{x_{i,t} - \\bar{x}_{i,<t}}{\\sigma_{i,<t}}\n$$\n\n其中 $\\bar{x}_{i,<t}, \\sigma_{i,<t}$ 是股票 $i$ 在 $t$ **之前**的均值/标准差。\n\n✅ **适用场景**：特征在不同股票间量纲差异大（如成交量）\n\n:::{.callout-warning}\n⚠️ 避免信息泄露\n\n**错误**：用包含测试期的统计量标准化\n\n```python\n# 错误！scaler 看到了测试集数据\nscaler.fit(X_train + X_test)\n```\n\n**正确**：仅用训练期拟合\n\n```python\n# 正确！\nscaler.fit(X_train)\nX_train_scaled = scaler.transform(X_train)\nX_test_scaled = scaler.transform(X_test)  # 用训练期参数转换\n```\n:::\n\n## 时序数据评估规范\n\n### 为什么 K 折交叉验证不适用？\n\n**K 折 CV 的假设**：训练集和验证集可互换（i.i.d.）\n\n**金融时序的现实**：\n\n- 未来不可用于预测过去（因果性）\n- 数据分布随时间变化（非平稳）\n- 若打乱时间顺序，会造成严重的**前瞻偏误**\n\n:::{.callout-caution}\n🚫 禁止操作\n\n```python\n# 危险！时序数据不能用标准 K 折\nfrom sklearn.model_selection import KFold\nkf = KFold(n_splits=5, shuffle=True)  # shuffle=True 破坏时序\n```\n:::\n\n### 时序数据的正确划分\n\n#### 基本时间切分\n\n```\n历史数据  │  样本内评估期  │  样本外评估期\n─────────┼───────────────┼──────────────→ 时间\n  Train  │    Validation │      Test\n```\n\n**原则**：\n\n- 训练集：最早的数据\n- 验证集：训练集之后\n- 测试集：验证集之后（仅用一次！）\n\n#### 滚动窗口（Rolling Window）\n\n**固定训练窗口长度**，逐步向前滚动：\n\n```\n时间:  1 2 3 4 5 6 7 8 9 10 11 12\n\n迭代1: [Train: 1-5] → Predict: 6\n迭代2:   [Train: 2-6] → Predict: 7\n迭代3:     [Train: 3-7] → Predict: 8\n迭代4:       [Train: 4-8] → Predict: 9\n...\n```\n\n**优点**：\n\n- 模型保持\"新鲜\"，适应非平稳性\n- 计算成本可控\n\n**缺点**：\n\n- 丢弃早期数据，样本量小\n- 窗口长度需调优\n\n#### 扩展窗口（Expanding Window）\n\n**累积所有历史数据**，窗口不断扩大：\n\n```\n时间:  1 2 3 4 5 6 7 8 9 10 11 12\n\n迭代1: [Train: 1-5] → Predict: 6\n迭代2: [Train: 1-6] → Predict: 7\n迭代3: [Train: 1-7] → Predict: 8\n迭代4: [Train: 1-8] → Predict: 9\n...\n```\n\n**优点**：\n\n- 充分利用历史数据，样本量大\n- 估计更稳定\n\n**缺点**：\n\n- 早期数据可能过时\n- 计算成本高（训练集不断增长）\n\n#### 选择建议\n\n| 场景 | 推荐方法 |\n|-----|---------|\n| 数据平稳、样本少 | 扩展窗口 |\n| 数据非平稳明显 | 滚动窗口（短窗口）|\n| 不确定 | 两者都试，对比稳健性 |\n\n### 嵌套时序评估（Nested Time Series CV）\n\n**问题**：超参数（如正则化强度 $\\lambda$）如何选择？\n\n**错误做法**：在测试集上调参（数据窥探！）\n\n**正确做法**：嵌套结构，分离\"调参\"与\"泛化评估\"\n\n#### 嵌套结构示意\n\n```\n外层循环（泛化评估）:\n┌────────────────────────────────────────────────────┐\n│ Train + Val (合并) │ → Model(best λ) → │ Test_1    │\n└────────────────────────────────────────────────────┘\n    内层循环（选 λ）:\n    ┌──────────────────┬─────────────┐\n    │   Train_inner    │  Val_inner  │  → 试 λ1, λ2, ...\n    └──────────────────┴─────────────┘\n\n然后滚动到下一期...\n\n┌────────────────────────────────────────────────────┐\n│   Train + Val (合并)   │ → Model(best λ) → │Test_2  │\n└────────────────────────────────────────────────────┘\n    内层循环（重新选 λ）:\n    ┌──────────────────┬─────────────┐\n    │   Train_inner    │  Val_inner  │\n    └──────────────────┴─────────────┘\n```\n\n#### 伪代码\n\n```python\ntest_scores = []\n\nfor test_start in test_periods:\n    # 外层：定义本期测试集\n    train_val = data[data.date < test_start]\n    test = data[data.date >= test_start]\n    \n    # 内层：在 train_val 上用时序 CV 选超参数\n    best_lambda = None\n    best_val_score = -inf\n    \n    for lambda_candidate in lambda_grid:\n        val_scores_inner = []\n        for val_start in validation_periods:\n            train_inner = train_val[train_val.date < val_start]\n            val_inner = train_val[train_val.date >= val_start]\n            \n            model.fit(train_inner, lambda=lambda_candidate)\n            val_scores_inner.append(model.score(val_inner))\n        \n        avg_val_score = mean(val_scores_inner)\n        if avg_val_score > best_val_score:\n            best_val_score = avg_val_score\n            best_lambda = lambda_candidate\n    \n    # 外层：用最优超参数训练最终模型\n    model.fit(train_val, lambda=best_lambda)\n    test_scores.append(model.score(test))\n\n# 报告样本外性能\nfinal_oos_score = mean(test_scores)\n```\n\n:::{.callout-tip}\n💡 实践建议\n\n- **内层窗口可以更短**：调参不需要太长历史\n- **外层跨度看研究问题**：月度/季度/年度重训练\n- **计算成本高**：可先在小数据集上探索，再全量运行\n:::\n\n## 回测卫生清单（Backtesting Hygiene）\n\n### 常见偏误类型\n\n#### 存活偏误（Survivorship Bias）\n\n**问题**：只用当前仍存在的股票回测，忽略退市股票。\n\n**后果**：\n\n- 高估策略收益（退市股通常表现差）\n- 低估风险（极端亏损被排除）\n\n**解决**：\n\n- 使用**包含退市股的全历史数据库**\n- 记录退市日期与退市收益\n\n#### 数据回填（Backfilled Data）\n\n**问题**：数据供应商事后修正历史数据（如重述财报）。\n\n**后果**：用到了当时不可得的\"修正后\"数据。\n\n**解决**：\n\n- 使用**时间点数据库**（point-in-time database）\n- 记录每个数据点的\"as of\"日期\n\n#### 公司行动处理（Corporate Actions）\n\n**未调整**：\n\n- 股票分拆/合并（如1股拆3股）\n- 现金分红（影响收益计算）\n- 配股/增发\n\n**解决**：\n\n- 使用**复权价格**（adjusted prices）\n- 或手动调整收益序列\n\n#### 停牌处理\n\n**问题**：停牌期间无法交易，但收益率序列可能显示\"0\"或\"缺失\"。\n\n**后果**：\n\n- 错误假设可以在停牌期买入/卖出\n- 低估流动性风险\n\n**解决**：\n\n- 标记停牌日期\n- 回测中跳过停牌股票或延迟调仓\n\n#### 样本选择与数据窥探（Data Snooping）\n\n**问题**：\n\n- 在多次尝试后只报告最好的结果\n- 根据整个样本期的特征选择模型/特征\n\n**后果**：\n\n- 样本外表现远低于预期\n- 无法复现\n\n**解决**：\n\n- **预先登记**研究设计（pre-registration）\n- 报告所有尝试（包括失败的）\n- 用**独立测试集**或**新数据期**验证\n\n### 调仓时点与执行滞后\n\n#### 调仓时点设计\n\n**典型流程**：\n\n```\n月末 t: 观察所有可得信息 x_t\n  ↓\n月初 t+1: 计算预测信号 f(x_t)\n  ↓\n开盘后: 执行交易，形成新组合\n  ↓\n月末 t+1: 观察收益 r_{t+1}\n```\n\n**关键问题**：\n\n1. 何时计算信号？（需确保数据已可得）\n2. 何时执行交易？（开盘/收盘/盘中均价？）\n3. 是否有执行滞后？（如需 T+1 日才能成交）\n\n#### 执行价格\n\n**保守假设**：\n\n- 买入用**更高的价格**（如开盘价 + 滑点）\n- 卖出用**更低的价格**（如开盘价 - 滑点）\n\n**示例**：\n\n```python\n# 假设在月初第一个交易日开盘价执行\nentry_price = open_price * (1 + slippage)  # 买入\nexit_price = open_price * (1 - slippage)   # 卖出\n```\n\n## 评估指标：从预测到组合\n\n### 预测层面指标\n\n#### 样本外 $R^2$（Out-of-Sample $R^2$）\n\n$$\nR^2_{\\text{OOS}} = 1 - \\frac{\\sum_{t \\in \\text{OOS}} (r_t - \\hat{r}_t)^2}{\\sum_{t \\in \\text{OOS}} (r_t - \\bar{r}_{\\text{hist}})^2}\n$$\n\n其中 $\\bar{r}_{\\text{hist}}$ 是历史均值（仅用训练期）。\n\n**解释**：\n\n- 相对于\"历史均值预测\"的改进\n- 可能为负（模型比均值还差）\n- GKY (2020) 中 $R^2_{\\text{OOS}} \\approx 0.5\\%$ 已属优秀\n\n#### 信息系数（IC）与 Rank IC\n\n**IC**（Information Coefficient）：预测值与实际值的相关系数\n\n$$\n\\text{IC}_t = \\text{Corr}(\\hat{r}_{i,t}, r_{i,t})\n$$\n\n**Rank IC**：排序相关（Spearman）\n\n$$\n\\text{Rank-IC}_t = \\text{Spearman}(\\hat{r}_{i,t}, r_{i,t})\n$$\n\n**优点**：\n\n- 更关注排序而非数值精度\n- 对异常值更鲁棒（Rank IC）\n\n**典型值**：\n\n- $|\\text{IC}| > 0.05$ 已有实用价值\n- $|\\text{IC}| > 0.10$ 属强信号\n\n### 组合层面指标\n\n#### 构建多空组合\n\n**基于预测分数排序**：\n\n1. 每期将股票按 $\\hat{r}_{i,t}$ 排序\n2. 做多前 20%（或前十分位）\n3. 做空后 20%（或后十分位）\n4. 计算组合收益\n\n#### 年化超额收益\n\n$$\n\\bar{r}^e_{\\text{annual}} = 12 \\times \\frac{1}{T}\\sum_{t=1}^T r^e_t \\quad \\text{（月度数据）}\n$$\n\n#### 夏普比率（Sharpe Ratio）\n\n$$\n\\text{Sharpe} = \\frac{\\bar{r}^e}{\\sigma(r^e)} \\times \\sqrt{12}\n$$\n\n**解释**：单位风险的超额收益\n\n**典型值**：\n\n- Sharpe > 1：优秀\n- Sharpe > 2：非常优秀（需警惕过拟合）\n\n#### 信息比率（Information Ratio）\n\n$$\n\\text{IR} = \\frac{\\bar{r}^e - r^{\\text{benchmark}}}{\\sigma(r^e - r^{\\text{benchmark}})}\n$$\n\n**解释**：相对基准的超额收益稳定性\n\n#### 最大回撤（Maximum Drawdown）\n\n$$\n\\text{MDD} = \\max_{t} \\left[\\max_{s \\leq t} \\text{Cumulative Return}_s - \\text{Cumulative Return}_t\\right]\n$$\n\n**解释**：从峰值到谷底的最大损失\n\n#### 换手率（Turnover）\n\n$$\n\\text{Turnover}_t = \\frac{1}{2}\\sum_{i} |w_{i,t} - w_{i,t-1}^+|\n$$\n\n其中 $w_{i,t-1}^+$ 是 $t-1$ 期末持仓权重（考虑价格变化）。\n\n**重要性**：\n\n- 高换手 → 高交易成本\n- 需权衡信号强度与稳定性\n\n#### 成本后净收益\n\n$$\nr^{\\text{net}}_t = r^{\\text{gross}}_t - \\text{Cost}_t\n$$\n\n**成本构成**：\n\n- **佣金**：$c \\times \\text{Turnover}_t$（如 $c = 0.1\\%$）\n- **冲击成本**：$\\alpha \\times \\sqrt{\\text{Trade Size}}$\n- **融券费用**：做空头寸的借券成本\n\n:::{.callout-warning}\n⚠️ 成本往往被低估\n\n- 小市值股票冲击成本远超大盘股\n- 危机时期融券费用飙升\n- 实际执行中的滑点\n:::\n\n### 切片评估与稳健性检验\n\n#### 时间切片\n\n**不同市场状态**：\n\n- 牛市 vs 熊市\n- 高波动 vs 低波动\n- 危机期 vs 平稳期\n\n**检验**：策略是否在各时期稳健？\n\n#### 横截面切片\n\n**不同资产特征**：\n\n- 大市值 vs 小市值\n- 高流动性 vs 低流动性\n- 不同行业/板块\n\n**检验**：策略收益来源是否过于集中？\n\n#### 稳健性检验\n\n1. **换窗口长度**：滚动窗口 3年 vs 5年\n2. **换再平衡频率**：月度 vs 季度\n3. **换组合构建**：等权 vs 市值加权\n4. **剔除极端期**：去掉危机月份，策略是否仍有效？\n\n## 模型选择与组合构建\n\n### 模型性能对比（参照 GKY 2020）\n\n#### 主要发现\n\n| 模型类别 | $R^2_{\\text{OOS}}$ | 夏普比率 | 优点 | 缺点 |\n|-----------|------|------|----------|----------|\n| **线性（Lasso/Elastic Net）** | 0.30% | 1.2 | 可解释，稳定 | 表达力有限 |\n| **树模型（Random Forest, GBM）** | 0.40% | 1.5 | 捕捉非线性，重要性解释 | 易过拟合 |\n| **神经网络（DNN）** | 0.50% | 1.6 | 最强表达力 | 黑箱，不稳定 |\n| **组合（Ensemble）** | **0.55%** | **1.7** | 稳健性最佳 | 复杂度高 |\n\n#### 核心结论\n\n1. **非线性方法表现更好**，但优势有限（0.1-0.2% $R^2$）\n2. **模型组合**优于单一模型（分散过拟合风险）\n3. **正则化至关重要**（无论线性还是非线性）\n\n### 从预测到组合的映射\n\n#### 简单排序（Rank-based）\n\n```python\n# 每期按预测分数排序\nscores = model.predict(X_t)\nranks = scores.argsort()\n\n# 构建多空组合\nlong = ranks[-n_top:]   # 前 n 名\nshort = ranks[:n_top]   # 后 n 名\n\nportfolio = equal_weight(long) - equal_weight(short)\n```\n\n**优点**：简单，鲁棒\n\n**缺点**：忽略预测强度差异\n\n#### 比例权重（Proportional）\n\n$$\nw_i \\propto \\hat{r}_i\n$$\n\n归一化使 $\\sum w_i = 1$。\n\n**优点**：利用预测强度信息\n\n**缺点**：对极端预测敏感\n\n#### 均值-方差优化（Mean-Variance）\n\n$$\n\\max_{\\mathbf{w}} \\quad \\mathbf{w}^\\top \\hat{\\boldsymbol{\\mu}} - \\frac{\\lambda}{2} \\mathbf{w}^\\top \\hat{\\boldsymbol{\\Sigma}} \\mathbf{w}\n$$\n\n其中 $\\hat{\\boldsymbol{\\mu}}$ 是预测收益，$\\hat{\\boldsymbol{\\Sigma}}$ 是协方差矩阵。\n\n**优点**：考虑风险\n\n**缺点**：\n\n- 协方差矩阵估计误差大\n- 对输入高度敏感（需正则化）\n\n#### 因子约束（Factor-neutral）\n\n控制对已知因子的暴露：\n\n$$\n\\mathbf{w}^\\top \\mathbf{F} = \\mathbf{0}\n$$\n\n其中 $\\mathbf{F}$ 是因子载荷矩阵（如市场、规模、价值）。\n\n**优点**：纯粹的 alpha，风险更可控\n\n### 模型组合策略\n\n#### 简单平均（Simple Average）\n\n$$\n\\hat{r}^{\\text{ens}}_i = \\frac{1}{M}\\sum_{m=1}^M \\hat{r}^{(m)}_i\n$$\n\n**优点**：最简单，通常效果好\n\n#### 加权平均（Weighted Average）\n\n$$\n\\hat{r}^{\\text{ens}}_i = \\sum_{m=1}^M w_m \\hat{r}^{(m)}_i\n$$\n\n权重 $w_m$ 根据验证集表现确定。\n\n#### Stacking\n\n训练一个**元模型**，以各模型预测为输入：\n\n```\n模型1预测 ──┐\n模型2预测 ──┼──→ 元模型 ──→ 最终预测\n模型3预测 ──┘\n```\n\n**优点**：自动学习最优组合\n\n**缺点**：增加过拟合风险（需嵌套 CV）\n\n## 本周小结\n\n### 核心要点\n\n1. **金融预测的特殊挑战**：低信噪比、非平稳、交易约束\n2. **信息可得性**：特征对齐、披露滞后、无前瞻偏误\n3. **时序评估**：滚动/扩展窗口、嵌套 CV、禁用标准 K 折\n4. **回测卫生**：存活偏误、数据回填、执行滞后等\n5. **评估体系**：预测指标（IC）+ 组合指标（Sharpe, 成本后收益）\n6. **模型选择**：正则化、集成、预测到组合的映射\n\n### 本周思考题\n\n#### 问题 1\n\n一个拥有较高样本外预测指标（如 OS-$R^2$ 或 IC）的模型,为何在真实交易中仍可能表现很差？请至少列出三个原因，并指出它们分别对应哪一类\"回测卫生\"问题或\"经济约束\"。\n\n:::{.callout-note collapse=\"true\"}\n💡 参考答案\n\n1. **交易成本**（经济约束）\n   - 高换手率策略的佣金与冲击成本\n   - 可能吞噬全部预测收益\n\n2. **流动性不足**（经济约束）\n   - 信号偏好小市值股票\n   - 大资金无法实际交易\n\n3. **执行滞后**（回测卫生）\n   - 回测假设即时执行\n   - 实际可能 T+1 或更晚，信号衰减\n\n4. **数据窥探**（回测卫生）\n   - 在测试集上反复调参\n   - 样本外真实表现被高估\n\n5. **市场冲击**（经济约束）\n   - 大额交易改变价格\n   - 回测未考虑自身交易的影响\n:::\n\n#### 问题 2\n\n如果你的特征中包含会计变量（存在披露滞后），滚动窗口评估中最常见的信息泄露路径是什么？你会如何在数据对齐上规避？\n\n:::{.callout-note collapse=\"true\"}\n💡 参考答案\n\n**常见泄露路径**：\n\n用当期年报数据预测当期收益，忽略年报通常在次年 3-4 月才披露。\n\n**规避方法**：\n\n1. **记录披露日期**\n   ```python\n   df['report_date']     # 报告期（如 2023-12-31）\n   df['announce_date']   # 实际披露日（如 2024-04-30）\n   ```\n\n2. **对齐规则**\n   ```python\n   # 只用已披露的最新数据\n   df = df[df['announce_date'] < df['trade_date']]\n   ```\n\n3. **保守假设**\n   - 年报假设次年 5 月 1 日可得\n   - 季报假设下一季度首月可得\n:::\n\n#### 问题 3\n\n结合 Gu, Kelly, Xiu (2020) 的经验事实，你会如何在\"预测性能—稳定性—可解释性\"之间权衡选择模型，并将其输出转化为一个可交易的组合？\n\n:::{.callout-note collapse=\"true\"}\n💡 参考答案\n\n**权衡策略**：\n\n1. **预测性能**：神经网络 > 树模型 > 线性\n   - 但边际提升有限（0.1-0.2% $R^2$）\n\n2. **稳定性**：线性 ≈ 模型组合 > 树模型 > 神经网络\n   - 金融低信噪比环境下，稳定性更重要\n\n3. **可解释性**：线性 > 树模型 > 神经网络\n   - 监管与风控需求\n\n**推荐方案**：\n\n- **研究导向**：使用线性（Elastic Net）作为基准，树/神经网络探索非线性\n- **实盘导向**：多模型组合（平均或 stacking），平衡性能与稳健性\n- **转化为组合**：\n  1. 按预测分数排序\n  2. 做多前十分位，做空后十分位\n  3. 等权或根据流动性调整权重\n  4. 月度再平衡，控制换手率 < 50%\n:::\n\n---\n\n### 下周预告\n\n第3周进入**文本分析**领域：\n\n- 文本表示方法演进（词袋 → BERT）\n- 语料治理：版本、对齐、去噪\n- 从原始文档到可用变量的审计流程\n- 增量信息检验与经济含义\n\n**预习阅读**：\n\n- Eisfeldt & Schubert (2024) *Generative AI and Finance*\n- Gentzkow, Kelly & Taddy (2019) *Text as Data*\n- Ludwig, Mullainathan & Rambachan (2025) *LLMs: an applied econometric framework*\n\n**预习任务**：选一种感兴趣的金融文本（年报/新闻/研报/社媒），思考它最容易产生的\"前瞻/对齐错误\"是什么。\n","srcMarkdownNoYaml":"\n\n## 资产定价预测的\"特别之处\"\n\n### 与典型监督学习的差异\n\n:::{.callout-important}\n🎯 核心认知\n\n资产定价预测**远比标准 i.i.d. 监督学习困难**，原因在于：\n\n1. **极低信噪比**：可预测成分通常 < 5% 方差\n2. **非平稳性**：数据分布随时间变化\n3. **横截面相关**：资产间高度关联\n4. **交易约束**：预测好 ≠ 可交易 ≠ 能赚钱\n:::\n\n#### 低信噪比（Low Signal-to-Noise Ratio）\n\n**典型事实**（来自 Gu, Kelly, Xiu 2020）：\n\n- 个股月度收益预测的 $R^2_{\\text{OOS}} \\approx 0.5\\%$\n- 即使最优模型，95%+ 方差仍是噪声\n- 对比：图像分类任务 $R^2 > 90\\%$\n\n**含义**：\n\n- 复杂模型极易将噪声误认为信号\n- 正则化与集成方法至关重要\n- 评估指标需关注**排序能力**而非绝对预测精度\n\n#### 非平稳性（Non-stationarity）\n\n**表现**：\n\n- 均值/方差随时间变化（如牛市 vs 熊市）\n- 特征–收益关系不稳定（如价值因子的衰退）\n- 新信息源出现（如社交媒体数据）\n\n**挑战**：\n\n- 历史数据未必代表未来\n- 模型需定期重训练\n- 需检验不同市场状态下的稳健性\n\n#### 横截面相关性（Cross-sectional Dependence）\n\n**现实**：\n\n- 股票收益受共同因子驱动（市场、行业、风格）\n- 相关性在危机时期飙升\n- 违反 i.i.d. 假设中的\"独立性\"\n\n**影响**：\n\n- 标准误估计偏小（需聚类调整）\n- 组合风险管理更复杂\n- 需控制因子暴露\n\n#### 交易约束与成本\n\n**现实约束**：\n\n- **流动性**：小市值股票难以大规模交易\n- **交易成本**：佣金、冲击成本、税费\n- **卖空限制**：部分市场卖空困难或成本高\n- **杠杆限制**：借贷成本与上限\n\n:::{.callout-warning}\n⚠️ 为何\"预测更准\"不等于\"更赚钱\"？\n\n**案例**：模型 A 预测 IC = 0.08，模型 B 预测 IC = 0.06\n\n- 若模型 A 的信号波动大 → 高换手率 → 交易成本吞噬收益\n- 若模型 A 偏好小市值股 → 流动性不足 → 难以实施\n- **结论**：模型 B 可能成本后表现更好\n:::\n\n## 问题解构与特征工程\n\n### 预测对象的选择\n\n#### 个股收益（Individual Stock Returns）\n\n$$\nr_{i,t+h} = \\log\\left(\\frac{P_{i,t+h}}{P_{i,t}}\\right)\n$$\n\n- **优点**：直接可交易，信息丰富\n- **缺点**：噪声大，需处理退市/分红\n\n#### 超额收益（Excess Returns）\n\n$$\nr^e_{i,t+h} = r_{i,t+h} - r_{f,t+h}\n$$\n\n或对市场调整：\n\n$$\nr^e_{i,t+h} = r_{i,t+h} - r_{m,t+h}\n$$\n\n- **优点**：去除市场共同成分，提升信噪比\n- **缺点**：需选择基准\n\n#### 多空组合收益（Long-Short Portfolio Returns）\n\n根据预测信号构建分位数组合：\n\n$$\nr^{LS}_{t+h} = r^{\\text{High}}_{t+h} - r^{\\text{Low}}_{t+h}\n$$\n\n- **优点**：直接评估策略表现\n- **缺点**：损失个股级信息\n\n### 特征工程：信息集与时间对齐\n\n#### 信息可得性规则（Information Availability）\n\n:::{.callout-important}\n🔑 黄金法则\n\n**在时刻 $t$ 用于预测的特征，必须在 $t$ 时刻已公开可得！**\n:::\n\n**常见陷阱**：\n\n1. **会计变量披露滞后**\n\n```\n错误：用 2023 年报数据预测 2023 年收益\n正确：用 2022 年报（2023年4月披露）预测 2023年5月后收益\n```\n\n2. **价格数据的\"收盘价陷阱\"**\n\n```\n错误：用 t 日收盘价预测 t 日收益\n正确：用 t-1 日收盘价预测 t 日收益\n```\n\n3. **分析师预测的\"修订滞后\"**\n\n```\n需记录：每个预测的发布时间戳\n对齐：只用发布时间 < t 的预测\n```\n\n#### 特征类别与对齐策略\n\n| 特征类别 | 更新频率 | 披露滞后 | 对齐策略 |\n|---------|---------|---------|---------|\n| **价格/成交量** | 日 | 无 | 用 $t-1$ 预测 $t$ |\n| **会计变量** | 季/年 | 1-4 个月 | 记录披露日期 |\n| **分析师预测** | 不定期 | 无 | 记录时间戳 |\n| **新闻/文本** | 实时 | 几乎无 | 记录发布时间 |\n| **宏观经济** | 月/季 | 数周 | 记录发布日期 |\n\n#### 缺失值处理的时间规范\n\n**原则**：填补方法不能使用未来信息。\n\n✅ **正确做法**：\n\n```python\n# 前向填充（用最近的已知值）\ndf['feature'] = df.groupby('stock_id')['feature'].ffill()\n\n# 或用历史均值（仅用 t 之前数据）\ndf['feature'] = df['feature'].fillna(df['feature'].expanding().mean())\n```\n\n❌ **错误做法**：\n\n```python\n# 用全局均值（包含未来数据）\ndf['feature'] = df['feature'].fillna(df['feature'].mean())\n```\n\n### 标准化的时间规范\n\n**横截面标准化**（cross-sectional）：\n\n$$\n\\tilde{x}_{i,t} = \\frac{x_{i,t} - \\bar{x}_t}{\\sigma_t}\n$$\n\n其中 $\\bar{x}_t, \\sigma_t$ 是时刻 $t$ 的横截面均值/标准差。\n\n✅ **适用场景**：特征在不同时期量纲差异大（如市盈率）\n\n**时间序列标准化**：\n\n$$\n\\tilde{x}_{i,t} = \\frac{x_{i,t} - \\bar{x}_{i,<t}}{\\sigma_{i,<t}}\n$$\n\n其中 $\\bar{x}_{i,<t}, \\sigma_{i,<t}$ 是股票 $i$ 在 $t$ **之前**的均值/标准差。\n\n✅ **适用场景**：特征在不同股票间量纲差异大（如成交量）\n\n:::{.callout-warning}\n⚠️ 避免信息泄露\n\n**错误**：用包含测试期的统计量标准化\n\n```python\n# 错误！scaler 看到了测试集数据\nscaler.fit(X_train + X_test)\n```\n\n**正确**：仅用训练期拟合\n\n```python\n# 正确！\nscaler.fit(X_train)\nX_train_scaled = scaler.transform(X_train)\nX_test_scaled = scaler.transform(X_test)  # 用训练期参数转换\n```\n:::\n\n## 时序数据评估规范\n\n### 为什么 K 折交叉验证不适用？\n\n**K 折 CV 的假设**：训练集和验证集可互换（i.i.d.）\n\n**金融时序的现实**：\n\n- 未来不可用于预测过去（因果性）\n- 数据分布随时间变化（非平稳）\n- 若打乱时间顺序，会造成严重的**前瞻偏误**\n\n:::{.callout-caution}\n🚫 禁止操作\n\n```python\n# 危险！时序数据不能用标准 K 折\nfrom sklearn.model_selection import KFold\nkf = KFold(n_splits=5, shuffle=True)  # shuffle=True 破坏时序\n```\n:::\n\n### 时序数据的正确划分\n\n#### 基本时间切分\n\n```\n历史数据  │  样本内评估期  │  样本外评估期\n─────────┼───────────────┼──────────────→ 时间\n  Train  │    Validation │      Test\n```\n\n**原则**：\n\n- 训练集：最早的数据\n- 验证集：训练集之后\n- 测试集：验证集之后（仅用一次！）\n\n#### 滚动窗口（Rolling Window）\n\n**固定训练窗口长度**，逐步向前滚动：\n\n```\n时间:  1 2 3 4 5 6 7 8 9 10 11 12\n\n迭代1: [Train: 1-5] → Predict: 6\n迭代2:   [Train: 2-6] → Predict: 7\n迭代3:     [Train: 3-7] → Predict: 8\n迭代4:       [Train: 4-8] → Predict: 9\n...\n```\n\n**优点**：\n\n- 模型保持\"新鲜\"，适应非平稳性\n- 计算成本可控\n\n**缺点**：\n\n- 丢弃早期数据，样本量小\n- 窗口长度需调优\n\n#### 扩展窗口（Expanding Window）\n\n**累积所有历史数据**，窗口不断扩大：\n\n```\n时间:  1 2 3 4 5 6 7 8 9 10 11 12\n\n迭代1: [Train: 1-5] → Predict: 6\n迭代2: [Train: 1-6] → Predict: 7\n迭代3: [Train: 1-7] → Predict: 8\n迭代4: [Train: 1-8] → Predict: 9\n...\n```\n\n**优点**：\n\n- 充分利用历史数据，样本量大\n- 估计更稳定\n\n**缺点**：\n\n- 早期数据可能过时\n- 计算成本高（训练集不断增长）\n\n#### 选择建议\n\n| 场景 | 推荐方法 |\n|-----|---------|\n| 数据平稳、样本少 | 扩展窗口 |\n| 数据非平稳明显 | 滚动窗口（短窗口）|\n| 不确定 | 两者都试，对比稳健性 |\n\n### 嵌套时序评估（Nested Time Series CV）\n\n**问题**：超参数（如正则化强度 $\\lambda$）如何选择？\n\n**错误做法**：在测试集上调参（数据窥探！）\n\n**正确做法**：嵌套结构，分离\"调参\"与\"泛化评估\"\n\n#### 嵌套结构示意\n\n```\n外层循环（泛化评估）:\n┌────────────────────────────────────────────────────┐\n│ Train + Val (合并) │ → Model(best λ) → │ Test_1    │\n└────────────────────────────────────────────────────┘\n    内层循环（选 λ）:\n    ┌──────────────────┬─────────────┐\n    │   Train_inner    │  Val_inner  │  → 试 λ1, λ2, ...\n    └──────────────────┴─────────────┘\n\n然后滚动到下一期...\n\n┌────────────────────────────────────────────────────┐\n│   Train + Val (合并)   │ → Model(best λ) → │Test_2  │\n└────────────────────────────────────────────────────┘\n    内层循环（重新选 λ）:\n    ┌──────────────────┬─────────────┐\n    │   Train_inner    │  Val_inner  │\n    └──────────────────┴─────────────┘\n```\n\n#### 伪代码\n\n```python\ntest_scores = []\n\nfor test_start in test_periods:\n    # 外层：定义本期测试集\n    train_val = data[data.date < test_start]\n    test = data[data.date >= test_start]\n    \n    # 内层：在 train_val 上用时序 CV 选超参数\n    best_lambda = None\n    best_val_score = -inf\n    \n    for lambda_candidate in lambda_grid:\n        val_scores_inner = []\n        for val_start in validation_periods:\n            train_inner = train_val[train_val.date < val_start]\n            val_inner = train_val[train_val.date >= val_start]\n            \n            model.fit(train_inner, lambda=lambda_candidate)\n            val_scores_inner.append(model.score(val_inner))\n        \n        avg_val_score = mean(val_scores_inner)\n        if avg_val_score > best_val_score:\n            best_val_score = avg_val_score\n            best_lambda = lambda_candidate\n    \n    # 外层：用最优超参数训练最终模型\n    model.fit(train_val, lambda=best_lambda)\n    test_scores.append(model.score(test))\n\n# 报告样本外性能\nfinal_oos_score = mean(test_scores)\n```\n\n:::{.callout-tip}\n💡 实践建议\n\n- **内层窗口可以更短**：调参不需要太长历史\n- **外层跨度看研究问题**：月度/季度/年度重训练\n- **计算成本高**：可先在小数据集上探索，再全量运行\n:::\n\n## 回测卫生清单（Backtesting Hygiene）\n\n### 常见偏误类型\n\n#### 存活偏误（Survivorship Bias）\n\n**问题**：只用当前仍存在的股票回测，忽略退市股票。\n\n**后果**：\n\n- 高估策略收益（退市股通常表现差）\n- 低估风险（极端亏损被排除）\n\n**解决**：\n\n- 使用**包含退市股的全历史数据库**\n- 记录退市日期与退市收益\n\n#### 数据回填（Backfilled Data）\n\n**问题**：数据供应商事后修正历史数据（如重述财报）。\n\n**后果**：用到了当时不可得的\"修正后\"数据。\n\n**解决**：\n\n- 使用**时间点数据库**（point-in-time database）\n- 记录每个数据点的\"as of\"日期\n\n#### 公司行动处理（Corporate Actions）\n\n**未调整**：\n\n- 股票分拆/合并（如1股拆3股）\n- 现金分红（影响收益计算）\n- 配股/增发\n\n**解决**：\n\n- 使用**复权价格**（adjusted prices）\n- 或手动调整收益序列\n\n#### 停牌处理\n\n**问题**：停牌期间无法交易，但收益率序列可能显示\"0\"或\"缺失\"。\n\n**后果**：\n\n- 错误假设可以在停牌期买入/卖出\n- 低估流动性风险\n\n**解决**：\n\n- 标记停牌日期\n- 回测中跳过停牌股票或延迟调仓\n\n#### 样本选择与数据窥探（Data Snooping）\n\n**问题**：\n\n- 在多次尝试后只报告最好的结果\n- 根据整个样本期的特征选择模型/特征\n\n**后果**：\n\n- 样本外表现远低于预期\n- 无法复现\n\n**解决**：\n\n- **预先登记**研究设计（pre-registration）\n- 报告所有尝试（包括失败的）\n- 用**独立测试集**或**新数据期**验证\n\n### 调仓时点与执行滞后\n\n#### 调仓时点设计\n\n**典型流程**：\n\n```\n月末 t: 观察所有可得信息 x_t\n  ↓\n月初 t+1: 计算预测信号 f(x_t)\n  ↓\n开盘后: 执行交易，形成新组合\n  ↓\n月末 t+1: 观察收益 r_{t+1}\n```\n\n**关键问题**：\n\n1. 何时计算信号？（需确保数据已可得）\n2. 何时执行交易？（开盘/收盘/盘中均价？）\n3. 是否有执行滞后？（如需 T+1 日才能成交）\n\n#### 执行价格\n\n**保守假设**：\n\n- 买入用**更高的价格**（如开盘价 + 滑点）\n- 卖出用**更低的价格**（如开盘价 - 滑点）\n\n**示例**：\n\n```python\n# 假设在月初第一个交易日开盘价执行\nentry_price = open_price * (1 + slippage)  # 买入\nexit_price = open_price * (1 - slippage)   # 卖出\n```\n\n## 评估指标：从预测到组合\n\n### 预测层面指标\n\n#### 样本外 $R^2$（Out-of-Sample $R^2$）\n\n$$\nR^2_{\\text{OOS}} = 1 - \\frac{\\sum_{t \\in \\text{OOS}} (r_t - \\hat{r}_t)^2}{\\sum_{t \\in \\text{OOS}} (r_t - \\bar{r}_{\\text{hist}})^2}\n$$\n\n其中 $\\bar{r}_{\\text{hist}}$ 是历史均值（仅用训练期）。\n\n**解释**：\n\n- 相对于\"历史均值预测\"的改进\n- 可能为负（模型比均值还差）\n- GKY (2020) 中 $R^2_{\\text{OOS}} \\approx 0.5\\%$ 已属优秀\n\n#### 信息系数（IC）与 Rank IC\n\n**IC**（Information Coefficient）：预测值与实际值的相关系数\n\n$$\n\\text{IC}_t = \\text{Corr}(\\hat{r}_{i,t}, r_{i,t})\n$$\n\n**Rank IC**：排序相关（Spearman）\n\n$$\n\\text{Rank-IC}_t = \\text{Spearman}(\\hat{r}_{i,t}, r_{i,t})\n$$\n\n**优点**：\n\n- 更关注排序而非数值精度\n- 对异常值更鲁棒（Rank IC）\n\n**典型值**：\n\n- $|\\text{IC}| > 0.05$ 已有实用价值\n- $|\\text{IC}| > 0.10$ 属强信号\n\n### 组合层面指标\n\n#### 构建多空组合\n\n**基于预测分数排序**：\n\n1. 每期将股票按 $\\hat{r}_{i,t}$ 排序\n2. 做多前 20%（或前十分位）\n3. 做空后 20%（或后十分位）\n4. 计算组合收益\n\n#### 年化超额收益\n\n$$\n\\bar{r}^e_{\\text{annual}} = 12 \\times \\frac{1}{T}\\sum_{t=1}^T r^e_t \\quad \\text{（月度数据）}\n$$\n\n#### 夏普比率（Sharpe Ratio）\n\n$$\n\\text{Sharpe} = \\frac{\\bar{r}^e}{\\sigma(r^e)} \\times \\sqrt{12}\n$$\n\n**解释**：单位风险的超额收益\n\n**典型值**：\n\n- Sharpe > 1：优秀\n- Sharpe > 2：非常优秀（需警惕过拟合）\n\n#### 信息比率（Information Ratio）\n\n$$\n\\text{IR} = \\frac{\\bar{r}^e - r^{\\text{benchmark}}}{\\sigma(r^e - r^{\\text{benchmark}})}\n$$\n\n**解释**：相对基准的超额收益稳定性\n\n#### 最大回撤（Maximum Drawdown）\n\n$$\n\\text{MDD} = \\max_{t} \\left[\\max_{s \\leq t} \\text{Cumulative Return}_s - \\text{Cumulative Return}_t\\right]\n$$\n\n**解释**：从峰值到谷底的最大损失\n\n#### 换手率（Turnover）\n\n$$\n\\text{Turnover}_t = \\frac{1}{2}\\sum_{i} |w_{i,t} - w_{i,t-1}^+|\n$$\n\n其中 $w_{i,t-1}^+$ 是 $t-1$ 期末持仓权重（考虑价格变化）。\n\n**重要性**：\n\n- 高换手 → 高交易成本\n- 需权衡信号强度与稳定性\n\n#### 成本后净收益\n\n$$\nr^{\\text{net}}_t = r^{\\text{gross}}_t - \\text{Cost}_t\n$$\n\n**成本构成**：\n\n- **佣金**：$c \\times \\text{Turnover}_t$（如 $c = 0.1\\%$）\n- **冲击成本**：$\\alpha \\times \\sqrt{\\text{Trade Size}}$\n- **融券费用**：做空头寸的借券成本\n\n:::{.callout-warning}\n⚠️ 成本往往被低估\n\n- 小市值股票冲击成本远超大盘股\n- 危机时期融券费用飙升\n- 实际执行中的滑点\n:::\n\n### 切片评估与稳健性检验\n\n#### 时间切片\n\n**不同市场状态**：\n\n- 牛市 vs 熊市\n- 高波动 vs 低波动\n- 危机期 vs 平稳期\n\n**检验**：策略是否在各时期稳健？\n\n#### 横截面切片\n\n**不同资产特征**：\n\n- 大市值 vs 小市值\n- 高流动性 vs 低流动性\n- 不同行业/板块\n\n**检验**：策略收益来源是否过于集中？\n\n#### 稳健性检验\n\n1. **换窗口长度**：滚动窗口 3年 vs 5年\n2. **换再平衡频率**：月度 vs 季度\n3. **换组合构建**：等权 vs 市值加权\n4. **剔除极端期**：去掉危机月份，策略是否仍有效？\n\n## 模型选择与组合构建\n\n### 模型性能对比（参照 GKY 2020）\n\n#### 主要发现\n\n| 模型类别 | $R^2_{\\text{OOS}}$ | 夏普比率 | 优点 | 缺点 |\n|-----------|------|------|----------|----------|\n| **线性（Lasso/Elastic Net）** | 0.30% | 1.2 | 可解释，稳定 | 表达力有限 |\n| **树模型（Random Forest, GBM）** | 0.40% | 1.5 | 捕捉非线性，重要性解释 | 易过拟合 |\n| **神经网络（DNN）** | 0.50% | 1.6 | 最强表达力 | 黑箱，不稳定 |\n| **组合（Ensemble）** | **0.55%** | **1.7** | 稳健性最佳 | 复杂度高 |\n\n#### 核心结论\n\n1. **非线性方法表现更好**，但优势有限（0.1-0.2% $R^2$）\n2. **模型组合**优于单一模型（分散过拟合风险）\n3. **正则化至关重要**（无论线性还是非线性）\n\n### 从预测到组合的映射\n\n#### 简单排序（Rank-based）\n\n```python\n# 每期按预测分数排序\nscores = model.predict(X_t)\nranks = scores.argsort()\n\n# 构建多空组合\nlong = ranks[-n_top:]   # 前 n 名\nshort = ranks[:n_top]   # 后 n 名\n\nportfolio = equal_weight(long) - equal_weight(short)\n```\n\n**优点**：简单，鲁棒\n\n**缺点**：忽略预测强度差异\n\n#### 比例权重（Proportional）\n\n$$\nw_i \\propto \\hat{r}_i\n$$\n\n归一化使 $\\sum w_i = 1$。\n\n**优点**：利用预测强度信息\n\n**缺点**：对极端预测敏感\n\n#### 均值-方差优化（Mean-Variance）\n\n$$\n\\max_{\\mathbf{w}} \\quad \\mathbf{w}^\\top \\hat{\\boldsymbol{\\mu}} - \\frac{\\lambda}{2} \\mathbf{w}^\\top \\hat{\\boldsymbol{\\Sigma}} \\mathbf{w}\n$$\n\n其中 $\\hat{\\boldsymbol{\\mu}}$ 是预测收益，$\\hat{\\boldsymbol{\\Sigma}}$ 是协方差矩阵。\n\n**优点**：考虑风险\n\n**缺点**：\n\n- 协方差矩阵估计误差大\n- 对输入高度敏感（需正则化）\n\n#### 因子约束（Factor-neutral）\n\n控制对已知因子的暴露：\n\n$$\n\\mathbf{w}^\\top \\mathbf{F} = \\mathbf{0}\n$$\n\n其中 $\\mathbf{F}$ 是因子载荷矩阵（如市场、规模、价值）。\n\n**优点**：纯粹的 alpha，风险更可控\n\n### 模型组合策略\n\n#### 简单平均（Simple Average）\n\n$$\n\\hat{r}^{\\text{ens}}_i = \\frac{1}{M}\\sum_{m=1}^M \\hat{r}^{(m)}_i\n$$\n\n**优点**：最简单，通常效果好\n\n#### 加权平均（Weighted Average）\n\n$$\n\\hat{r}^{\\text{ens}}_i = \\sum_{m=1}^M w_m \\hat{r}^{(m)}_i\n$$\n\n权重 $w_m$ 根据验证集表现确定。\n\n#### Stacking\n\n训练一个**元模型**，以各模型预测为输入：\n\n```\n模型1预测 ──┐\n模型2预测 ──┼──→ 元模型 ──→ 最终预测\n模型3预测 ──┘\n```\n\n**优点**：自动学习最优组合\n\n**缺点**：增加过拟合风险（需嵌套 CV）\n\n## 本周小结\n\n### 核心要点\n\n1. **金融预测的特殊挑战**：低信噪比、非平稳、交易约束\n2. **信息可得性**：特征对齐、披露滞后、无前瞻偏误\n3. **时序评估**：滚动/扩展窗口、嵌套 CV、禁用标准 K 折\n4. **回测卫生**：存活偏误、数据回填、执行滞后等\n5. **评估体系**：预测指标（IC）+ 组合指标（Sharpe, 成本后收益）\n6. **模型选择**：正则化、集成、预测到组合的映射\n\n### 本周思考题\n\n#### 问题 1\n\n一个拥有较高样本外预测指标（如 OS-$R^2$ 或 IC）的模型,为何在真实交易中仍可能表现很差？请至少列出三个原因，并指出它们分别对应哪一类\"回测卫生\"问题或\"经济约束\"。\n\n:::{.callout-note collapse=\"true\"}\n💡 参考答案\n\n1. **交易成本**（经济约束）\n   - 高换手率策略的佣金与冲击成本\n   - 可能吞噬全部预测收益\n\n2. **流动性不足**（经济约束）\n   - 信号偏好小市值股票\n   - 大资金无法实际交易\n\n3. **执行滞后**（回测卫生）\n   - 回测假设即时执行\n   - 实际可能 T+1 或更晚，信号衰减\n\n4. **数据窥探**（回测卫生）\n   - 在测试集上反复调参\n   - 样本外真实表现被高估\n\n5. **市场冲击**（经济约束）\n   - 大额交易改变价格\n   - 回测未考虑自身交易的影响\n:::\n\n#### 问题 2\n\n如果你的特征中包含会计变量（存在披露滞后），滚动窗口评估中最常见的信息泄露路径是什么？你会如何在数据对齐上规避？\n\n:::{.callout-note collapse=\"true\"}\n💡 参考答案\n\n**常见泄露路径**：\n\n用当期年报数据预测当期收益，忽略年报通常在次年 3-4 月才披露。\n\n**规避方法**：\n\n1. **记录披露日期**\n   ```python\n   df['report_date']     # 报告期（如 2023-12-31）\n   df['announce_date']   # 实际披露日（如 2024-04-30）\n   ```\n\n2. **对齐规则**\n   ```python\n   # 只用已披露的最新数据\n   df = df[df['announce_date'] < df['trade_date']]\n   ```\n\n3. **保守假设**\n   - 年报假设次年 5 月 1 日可得\n   - 季报假设下一季度首月可得\n:::\n\n#### 问题 3\n\n结合 Gu, Kelly, Xiu (2020) 的经验事实，你会如何在\"预测性能—稳定性—可解释性\"之间权衡选择模型，并将其输出转化为一个可交易的组合？\n\n:::{.callout-note collapse=\"true\"}\n💡 参考答案\n\n**权衡策略**：\n\n1. **预测性能**：神经网络 > 树模型 > 线性\n   - 但边际提升有限（0.1-0.2% $R^2$）\n\n2. **稳定性**：线性 ≈ 模型组合 > 树模型 > 神经网络\n   - 金融低信噪比环境下，稳定性更重要\n\n3. **可解释性**：线性 > 树模型 > 神经网络\n   - 监管与风控需求\n\n**推荐方案**：\n\n- **研究导向**：使用线性（Elastic Net）作为基准，树/神经网络探索非线性\n- **实盘导向**：多模型组合（平均或 stacking），平衡性能与稳健性\n- **转化为组合**：\n  1. 按预测分数排序\n  2. 做多前十分位，做空后十分位\n  3. 等权或根据流动性调整权重\n  4. 月度再平衡，控制换手率 < 50%\n:::\n\n---\n\n### 下周预告\n\n第3周进入**文本分析**领域：\n\n- 文本表示方法演进（词袋 → BERT）\n- 语料治理：版本、对齐、去噪\n- 从原始文档到可用变量的审计流程\n- 增量信息检验与经济含义\n\n**预习阅读**：\n\n- Eisfeldt & Schubert (2024) *Generative AI and Finance*\n- Gentzkow, Kelly & Taddy (2019) *Text as Data*\n- Ludwig, Mullainathan & Rambachan (2025) *LLMs: an applied econometric framework*\n\n**预习任务**：选一种感兴趣的金融文本（年报/新闻/研报/社媒），思考它最容易产生的\"前瞻/对齐错误\"是什么。\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"toc-depth":3,"number-sections":true,"html-math-method":"katex","output-file":"week2.html"},"language":{"toc-title-document":"目录","toc-title-website":"该页面内容","related-formats-title":"其他格式","related-notebooks-title":"笔记本","source-notebooks-prefix":"资源","other-links-title":"其他链接","code-links-title":"代码链接","launch-dev-container-title":"启动 Dev Container","launch-binder-title":"启动 Binder","article-notebook-label":"文章笔记本","notebook-preview-download":"下载笔记本","notebook-preview-download-src":"下载源代码","notebook-preview-back":"返回文章","manuscript-meca-bundle":"MECA 存档","section-title-abstract":"摘要","section-title-appendices":"附录","section-title-footnotes":"脚注","section-title-references":"参考文献","section-title-reuse":"二次使用","section-title-copyright":"版权","section-title-citation":"引用格式","appendix-attribution-cite-as":"请按如下格式引用：","appendix-attribution-bibtex":"BibTeX","appendix-view-license":"查看许可协议","title-block-author-single":"作者","title-block-author-plural":"作者","title-block-affiliation-single":"单位","title-block-affiliation-plural":"单位","title-block-published":"发布于","title-block-modified":"修改于","title-block-keywords":"关键词","callout-tip-title":"提示","callout-note-title":"注记","callout-warning-title":"警告","callout-important-title":"重要","callout-caution-title":"注意","code-summary":"代码","code-tools-menu-caption":"代码","code-tools-show-all-code":"显示所有代码","code-tools-hide-all-code":"隐藏所有代码","code-tools-view-source":"查看源代码","code-tools-source-code":"源代码","tools-share":"Share","tools-download":"Download","code-line":"行","code-lines":"行","copy-button-tooltip":"复制到剪贴板","copy-button-tooltip-success":"已复制","repo-action-links-edit":"编辑该页面","repo-action-links-source":"查看代码","repo-action-links-issue":"反馈问题","back-to-top":"回到顶部","search-no-results-text":"没有结果","search-matching-documents-text":"匹配的文档","search-copy-link-title":"复制搜索链接","search-hide-matches-text":"隐藏其它匹配结果","search-more-match-text":"更多匹配结果","search-more-matches-text":"更多匹配结果","search-clear-button-title":"清除","search-text-placeholder":"","search-detached-cancel-button-title":"取消","search-submit-button-title":"提交","search-label":"搜索","toggle-section":"展开或折叠此栏","toggle-sidebar":"展开或折叠侧边栏导航","toggle-dark-mode":"切换深色模式","toggle-reader-mode":"切换阅读器模式","toggle-navigation":"展开或折叠导航栏","crossref-fig-title":"图","crossref-tbl-title":"表","crossref-lst-title":"列表","crossref-thm-title":"定理","crossref-lem-title":"引理","crossref-cor-title":"推论","crossref-prp-title":"命题","crossref-cnj-title":"猜想","crossref-def-title":"定义","crossref-exm-title":"例","crossref-exr-title":"习题","crossref-ch-prefix":"章节","crossref-apx-prefix":"附录","crossref-sec-prefix":"小节","crossref-eq-prefix":"式","crossref-lof-title":"图索引","crossref-lot-title":"表索引","crossref-lol-title":"列表索引","environment-proof-title":"证","environment-remark-title":"注记","environment-solution-title":"解","listing-page-order-by":"排序方式","listing-page-order-by-default":"默认","listing-page-order-by-date-asc":"日期升序","listing-page-order-by-date-desc":"日期降序","listing-page-order-by-number-desc":"降序","listing-page-order-by-number-asc":"升序","listing-page-field-date":"日期","listing-page-field-title":"标题","listing-page-field-description":"描述","listing-page-field-author":"作者","listing-page-field-filename":"文件名","listing-page-field-filemodified":"修改时间","listing-page-field-subtitle":"副标题","listing-page-field-readingtime":"阅读时间","listing-page-field-wordcount":"字数统计","listing-page-field-categories":"分类","listing-page-minutes-compact":"{0} 分钟","listing-page-category-all":"全部","listing-page-no-matches":"无匹配项","listing-page-words":"{0} 字","listing-page-filter":"筛选","draft":"草稿"},"metadata":{"lang":"zh","fig-responsive":true,"quarto-version":"1.6.32","theme":"cosmo","title":"第2讲：资产定价中的机器学习应用","subtitle":"问题解构、特征工程与时序评估规范"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}